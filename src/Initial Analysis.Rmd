---
title: 'Group 3: Initial Analysis'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(error = TRUE)
library(tidyverse)
library(ggplot2)
library(lubridate)
library(EloRating)
```

## 1. Loading the data 

### Calculating Elo Score

The following code segment provided by the client will calculate the elo ratings of cows (Those only need to be ran once).


#### Elo score for Feed bin (Overall)
```{r elo score feed, message=TRUE}
read.csv('../data/replacement_with_THI.csv')
sub_repl <- replacement_THI %>% filter(Bin_type == 'Feed')
#shuffle the rows
#sub_repl <- sub_repl[sample(1:nrow(sub_repl)),]
sub_repl$index <- seq(1, nrow(sub_repl))
## Order replacements
elo_repl_list <- sub_repl[order(sub_repl$hour),c("Actor_cow", "Reactor_cow","hour", "Bin", "date")]
colnames(elo_repl_list)=c("winner","loser","time","bin", "date")
elo_repl_list$index <- seq(1, nrow(elo_repl_list))
#Calculate the ELO scores
elo_package_result=elo.seq(winner=as.character(elo_repl_list$winner),
                           loser=as.character(elo_repl_list$loser),
                           Date=elo_repl_list$date,
                           k=6,
                           #presence=presence_comb,
                           runcheck = F,
                           progressbar=T)
saveRDS(elo_package_result, "../data/elo_res_feed.rds")
logtable_feed <- elo_package_result[["logtable"]]
logtable_feed$index <- seq(1, nrow(logtable_feed))
logtable2_feed <- logtable_feed[, c("winner","loser", "Apost","Bpost", "index")]
logtable3_feed <- merge(logtable2_feed, elo_repl_list)
logtable3_feed$bin <- NULL
write.csv(logtable_feed, '../data/logtable_feed.csv')
write.csv(logtable2_feed, '../data/logtable2_feed.csv')
write.csv(logtable3_feed, '../data/logtable3_feed.csv')
```

#### Elo score for Water bin (Overall)
```{r elo score water, message=TRUE}
sub_repl <- replacement_THI %>% filter(Bin_type == 'Water')
#shuffle the rows
#sub_repl <- sub_repl[sample(1:nrow(sub_repl)),]
sub_repl$index <- seq(1, nrow(sub_repl))
## Order replacements
elo_repl_list <- sub_repl[order(sub_repl$hour),c("Actor_cow", "Reactor_cow","hour", "Bin", "date")]
colnames(elo_repl_list)=c("winner","loser","time","bin", "date")
elo_repl_list$index <- seq(1, nrow(elo_repl_list))
#Calculate the ELO scores 
elo_package_result=elo.seq(winner=as.character(elo_repl_list$winner),
                           loser=as.character(elo_repl_list$loser),
                           Date=elo_repl_list$date,
                           k=20,
                           #presence=presence_comb,
                           runcheck = F,
                           progressbar=T)
logtable_water <- elo_package_result[["logtable"]]
logtable_water$index <- seq(1, nrow(logtable_water))
logtable2_water <- logtable_water[, c("winner","loser", "Apost","Bpost", "index")]
logtable3_water <- merge(logtable2_water, elo_repl_list)
logtable3_water$bin <- NULL
saveRDS(elo_package_result, '../data/elo_res_water.rds')
write.csv(logtable_water, '../data/logtable_water.csv')
write.csv(logtable2_water, '../data/logtable2_water.csv')
write.csv(logtable3_water, '../data/logtable3_water.csv')
```


#### Elo score for Feed bin (high THI)(THI_max >= 65)
```{r elo score feed, message=TRUE}
sub_repl <- replacement_THI %>% filter(Bin_type == 'Feed', THI_max >= 65)
#shuffle the rows
#sub_repl <- sub_repl[sample(1:nrow(sub_repl)),]
sub_repl$index <- seq(1, nrow(sub_repl))

## Order replacements
elo_repl_list <- sub_repl[order(sub_repl$hour),c("Actor_cow", "Reactor_cow","hour", "Bin", "date")]
colnames(elo_repl_list)=c("winner","loser","time","bin", "date")
elo_repl_list$index <- seq(1, nrow(elo_repl_list))

#Calculate the ELO scores
elo_package_result=elo.seq(winner=as.character(elo_repl_list$winner),
                           loser=as.character(elo_repl_list$loser),
                           Date=elo_repl_list$date,
                           k=8,
                           #presence=presence_comb,
                           runcheck = F,
                           progressbar=T)

saveRDS(elo_package_result, "../data/elo_res_feed_high_THI.rds")

logtable_feed <- elo_package_result[["logtable"]]
logtable_feed$index <- seq(1, nrow(logtable_feed))

logtable2_feed <- logtable_feed[, c("winner","loser", "Apost","Bpost", "index")]

logtable3_feed <- merge(logtable2_feed, elo_repl_list)
logtable3_feed$bin <- NULL

write.csv(logtable_feed, '../data/logtable_feed_high_THI.csv')
write.csv(logtable2_feed, '../data/logtable2_feed_high_THI.csv')
write.csv(logtable3_feed, '../data/logtable3_feed_high_THI.csv')
```

#### Elo score for Feed bin (low THI) (THI < 65)
```{r elo score feed, message=TRUE}
sub_repl <- replacement_THI %>% filter(Bin_type == 'Feed', THI_max < 65)
#shuffle the rows
#sub_repl <- sub_repl[sample(1:nrow(sub_repl)),]
sub_repl$index <- seq(1, nrow(sub_repl))

## Order replacements
elo_repl_list <- sub_repl[order(sub_repl$hour),c("Actor_cow", "Reactor_cow","hour", "Bin", "date")]
colnames(elo_repl_list)=c("winner","loser","time","bin", "date")
elo_repl_list$index <- seq(1, nrow(elo_repl_list))

#Calculate the ELO scores
elo_package_result=elo.seq(winner=as.character(elo_repl_list$winner),
                           loser=as.character(elo_repl_list$loser),
                           Date=elo_repl_list$date,
                           k=8,
                           #presence=presence_comb,
                           runcheck = F,
                           progressbar=T)

saveRDS(elo_package_result, "../data/elo_res_feed_low_THI.rds")

logtable_feed <- elo_package_result[["logtable"]]
logtable_feed$index <- seq(1, nrow(logtable_feed))

logtable2_feed <- logtable_feed[, c("winner","loser", "Apost","Bpost", "index")]

logtable3_feed <- merge(logtable2_feed, elo_repl_list)
logtable3_feed$bin <- NULL

write.csv(logtable_feed, '../data/logtable_feed_low_THI.csv')
write.csv(logtable2_feed, '../data/logtable2_feed_low_THI.csv')
write.csv(logtable3_feed, '../data/logtable3_feed_low_THI.csv')
```

#### Elo score for Water bin (high THI)(THI_max >= 65)
```{r elo score water, message=TRUE}
sub_repl <- replacement_THI %>% filter(Bin_type == 'Water', THI_max >= 65)
#shuffle the rows
#sub_repl <- sub_repl[sample(1:nrow(sub_repl)),]
sub_repl$index <- seq(1, nrow(sub_repl))

## Order replacements
elo_repl_list <- sub_repl[order(sub_repl$hour),c("Actor_cow", "Reactor_cow","hour", "Bin", "date")]
colnames(elo_repl_list)=c("winner","loser","time","bin", "date")
elo_repl_list$index <- seq(1, nrow(elo_repl_list))


#Calculate the ELO scores 
elo_package_result=elo.seq(winner=as.character(elo_repl_list$winner),
                           loser=as.character(elo_repl_list$loser),
                           Date=elo_repl_list$date,
                           k=31,
                           #presence=presence_comb,
                           runcheck = F,
                           progressbar=T)

logtable_water <- elo_package_result[["logtable"]]
logtable_water$index <- seq(1, nrow(logtable_water))

logtable2_water <- logtable_water[, c("winner","loser", "Apost","Bpost", "index")]

logtable3_water <- merge(logtable2_water, elo_repl_list)
logtable3_water$bin <- NULL

saveRDS(elo_package_result, '../data/elo_res_water_high_THI.rds')
write.csv(logtable_water, '../data/logtable_water_high_THI.csv')
write.csv(logtable2_water, '../data/logtable2_water_high_THI.csv')
write.csv(logtable3_water, '../data/logtable3_water_high_THI.csv')
```

#### Elo score for Water bin (low THI)(THI_max < 65)
```{r elo score water, message=TRUE}
sub_repl <- replacement_THI %>% filter(Bin_type == 'Water', THI_max < 65)
#shuffle the rows
#sub_repl <- sub_repl[sample(1:nrow(sub_repl)),]
sub_repl$index <- seq(1, nrow(sub_repl))

## Order replacements
elo_repl_list <- sub_repl[order(sub_repl$hour),c("Actor_cow", "Reactor_cow","hour", "Bin", "date")]
colnames(elo_repl_list)=c("winner","loser","time","bin", "date")
elo_repl_list$index <- seq(1, nrow(elo_repl_list))


#Calculate the ELO scores 
elo_package_result=elo.seq(winner=as.character(elo_repl_list$winner),
                           loser=as.character(elo_repl_list$loser),
                           Date=elo_repl_list$date,
                           k=23,
                           #presence=presence_comb,
                           runcheck = F,
                           progressbar=T)

logtable_water <- elo_package_result[["logtable"]]
logtable_water$index <- seq(1, nrow(logtable_water))

logtable2_water <- logtable_water[, c("winner","loser", "Apost","Bpost", "index")]

logtable3_water <- merge(logtable2_water, elo_repl_list)
logtable3_water$bin <- NULL

saveRDS(elo_package_result, '../data/elo_res_water_low_THI.rds')
write.csv(logtable_water, '../data/logtable_water_low_THI.csv')
write.csv(logtable2_water, '../data/logtable2_water_low_THI.csv')
write.csv(logtable3_water, '../data/logtable3_water_low_THI.csv')
```
### Load tidy datasets
Now the data is tidied up, This should be run everytime, we start to run this file.
```{r load-logtables, message=TRUE}
read.csv('../data/replacement_with_THI.csv')
logtable3_water_high_THI <- read.csv('../data/logtable3_water_high_THI.csv')
logtable3_water_low_THI <- read.csv('../data/logtable3_water_low_THI.csv')
logtable3_feed_high_THI <- read.csv('../data/logtable3_feed_high_THI.csv')
logtable3_feed_low_THI <- read.csv('../data/logtable3_feed_low_THI.csv')
elo_res_water_low_THI <- readRDS('../data/elo_res_water_low_THI.rds')
elo_res_water_high_THI <- readRDS('../data/elo_res_water_high_THI.rds')
elo_res_feed_low_THI <- readRDS('../data/elo_res_feed_low_THI.rds')
elo_res_feed_high_THI <- readRDS('../data/elo_res_feed_high_THI.rds')
```

Generate/merge log table with the original dataset.
```{r generate-analysis-table, message=TRUE}
replacement_THI_water <- replacement_THI %>% filter(Bin_type == 'Water')
replacement_THI_water$index <-seq(1, nrow(replacement_THI_water))
selected_repcement_THI_water <- replacement_THI_water %>% select(Bin, Bin_type, Bout_interval, THI_mean, THI_max, THI_min, index)
cowrep_water <- selected_repcement_THI_water %>%
          inner_join(logtable3_water, by = c("index"))

replacement_THI_feed <- replacement_THI %>% filter(Bin_type == 'Feed')
replacement_THI_feed$index <-seq(1, nrow(replacement_THI_feed))
selected_repcement_THI_feed <- replacement_THI_feed %>% select(Bin, Bin_type, Bout_interval, THI_mean, THI_max, THI_min, index)
cowrep_feed <- selected_repcement_THI_feed %>%
          inner_join(logtable3_feed, by = c("index"))
```

## 2. EDA

```{r EDA-1, message=TRUE}
# check assumption (1) before we separate them into high/low THI
18 * length(unique(c(unique(replacement_THI_water$Actor_cow), unique(replacement_THI_water$Reactor_cow)))) <= nrow(replacement_THI_water)
18 * length(unique(c(unique(replacement_THI_feed$Actor_cow), unique(replacement_THI_feed$Reactor_cow)))) <= nrow(replacement_THI_feed)


# check assumption (1) after we separate them into high/low THI
cowrep_THI_high_water <- cowrep_water %>% filter(THI_max >= 65)
cowrep_THI_low_water<- cowrep_water %>% filter(THI_max < 65)
cowrep_THI_high_feed <- cowrep_feed %>% filter(THI_max >= 65)
cowrep_THI_low_feed <- cowrep_feed %>% filter(THI_max < 65)


16 * length(unique(c(unique(cowrep_THI_high_water$winner), unique(cowrep_THI_high_water$loser)))) <= nrow(cowrep_THI_high_water)
18 * length(unique(c(unique(cowrep_THI_low_water$winner), unique(cowrep_THI_low_water$loser)))) <= nrow(cowrep_THI_low_water)
18 * length(unique(c(unique(cowrep_THI_high_feed$winner), unique(cowrep_THI_high_feed$loser)))) <= nrow(cowrep_THI_high_feed)
18 * length(unique(c(unique(cowrep_THI_low_feed$winner), unique(cowrep_THI_low_feed$loser)))) <= nrow(cowrep_THI_low_feed)


cowrep_THI_high_water %>% distinct(winner, loser)
cowrep_THI_high_feed %>% distinct(winner, loser)
```
```{r EDA-2, message=FALSE}
group_THI_List <- list(cowrep_THI_high_water,
                       cowrep_THI_low_water,
                       cowrep_THI_high_feed,
                       cowrep_THI_low_feed)

lapply(group_THI_List, check_consec_dates)

check_consec_dates <- 
  function(group_THI) {
  group_THI <- group_THI[order(as.Date(group_THI$date, format="%Y-%m-%d")),]
  group_THI$consecutive <- c(NA,(diff(as.Date(group_THI$date))))
  group_THI <- group_THI %>% filter(consecutive > 1)
  return(group_THI)
  }
```

```{r EDA-3, message=FALSE}
check_consec_dates(cowrep_feed)
check_consec_dates(cowrep_water)
```

```{r EDA-4, message=FALSE}
##optimize k
#ores_water <- optimizek(elo_res_water, krange = c(1, 100), resolution = 100)
#ores_water$best

#ores_feed <- optimizek(elo_res_feed, krange = c(1, 100), resolution = 100)
#ores_feed$best

elo_res_water <- readRDS('../data/elo_res_water.rds')
elo_res_feed <- readRDS('../data/elo_res_feed.rds')
elo_res_water_low_THI <- readRDS('../data/elo_res_water_low_THI.rds')
elo_res_water_high_THI <- readRDS('../data/elo_res_water_high_THI.rds')
elo_res_feed_low_THI <- readRDS('../data/elo_res_feed_low_THI.rds')
elo_res_feed_high_THI <- readRDS('../data/elo_res_feed_high_THI.rds')


#ores_water_low_THI <- optimizek(elo_res_water_low_THI, krange = c(1, 100), resolution = 100)
#ores_water_low_THI$best
#ores_water_high_THI <- optimizek(elo_res_water_high_THI, krange = c(1, 100), resolution = 100)
#ores_water_high_THI$best
#ores_feed_low_THI <- optimizek(elo_res_feed_low_THI, krange = c(1, 100), resolution = 100)
#ores_feed_low_THI$best
#ores_feed_high_THI <- optimizek(elo_res_feed_high_THI, krange = c(1, 100), resolution = 100)
#ores_feed_high_THI$best


last_elo_water <- extract_elo(elo_res_water)
last_elo_feed <- extract_elo(elo_res_feed)
last_elo_water_low_THI <- extract_elo(elo_res_water_low_THI)
last_elo_water_high_THI <- extract_elo(elo_res_water_high_THI)
last_elo_feed_low_THI <- extract_elo(elo_res_feed_low_THI)
last_elo_feed_high_THI <- extract_elo(elo_res_feed_high_THI)

sorted_last_elo_feed <- last_elo_feed[sort(names(last_elo_feed))]
sorted_last_elo_water <- last_elo_water[sort(names(last_elo_water))]
low_THI_cows <- Reduce(intersect, list(names(last_elo_water_low_THI),names(last_elo_feed_low_THI)))
high_THI_cows <- Reduce(intersect, list(names(last_elo_water_high_THI),names(last_elo_feed_high_THI)))
water_cows <- Reduce(intersect, list(names(last_elo_water_low_THI),names(last_elo_water_high_THI)))
feed_cows <- Reduce(intersect, list(names(last_elo_feed_low_THI),names(last_elo_feed_high_THI)))
sorted_last_elo_feed_low_THI <- last_elo_feed_low_THI[sort(low_THI_cows)]
sorted_last_elo_feed_high_THI <- last_elo_feed_high_THI[sort(high_THI_cows)]
sorted_last_elo_water_low_THI <- last_elo_water_low_THI[sort(low_THI_cows)]
sorted_last_elo_water_high_THI <- last_elo_water_high_THI[sort(high_THI_cows)]



cor.test(x=unname(sorted_last_elo_water), y=unname(sorted_last_elo_feed), method = 'spearman')
cor.test(x=unname(sorted_last_elo_feed_high_THI), y=unname(sorted_last_elo_water_high_THI), method = 'spearman')
cor.test(x=unname(sorted_last_elo_feed_low_THI), y=unname(sorted_last_elo_water_low_THI), method = 'spearman')
cor.test(x=unname(last_elo_water_low_THI[sort(water_cows)]), y=unname(last_elo_water_high_THI[sort(water_cows)]), method = 'spearman')
cor.test(x=unname(last_elo_feed_low_THI[sort(feed_cows)]), y=unname(last_elo_feed_high_THI[sort(feed_cows)]), method = 'spearman')
```

