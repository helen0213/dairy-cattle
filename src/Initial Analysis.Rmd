---
title: 'Group 3: Initial Analysis'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(error = TRUE)
library(tidyverse)
library(ggplot2)
library(lubridate)
library(EloRating)
```

## 1. Loading the data 

### Calculating Elo Score

The following code segment provided by the client will calculate the elo ratings of cows (Those only need to be ran once).

```{r elo score, message=TRUE}
load("../data/replacement_with_THI.rda")
sub_repl <- replacement_THI
sub_repl$index <- seq(1, nrow(sub_repl))

## Order replacements
elo.repl.list <- sub_repl[order(sub_repl$hour),c("Actor_cow", "Reactor_cow","hour", "Bin", "date")]
colnames(elo.repl.list)=c("winner","loser","time","bin", "date")
elo.repl.list$index <- seq(1, nrow(elo.repl.list))


#Calculate the ELO scores 
elo_package_result=elo.seq(winner=as.character(elo.repl.list$winner),
                           loser=as.character(elo.repl.list$loser),
                           Date=elo.repl.list$date,
                           k=20,
                           #presence=presence_comb,
                           runcheck = F,
                           progressbar=T)

logtable <- elo_package_result[["logtable"]]
logtable$index <- seq(1, nrow(logtable))

logtable2 <- logtable[, c("winner","loser", "Apost","Bpost", "index")]

logtable3 <- merge(logtable2, elo.repl.list)
logtable3$bin <- NULL

write.csv(logtable, '../data/logtable.csv')
write.csv(logtable2, '../data/logtable2.csv')
write.csv(logtable3, '../data/logtable3.csv')
```

### Load tidy datasets
Now the data is tidied up, This should be run everytime, we start to run this file.
```{r load-logtables, message=TRUE}
load("../data/replacement_with_THI.rda")
logtable <- read.csv('../data/logtable.csv')
logtable2 <- read.csv('../data/logtable2.csv')
logtable3 <- read.csv('../data/logtable3.csv')

```

Generate/merge log table with the original dataset.
```{r generate-analysis-table, message=TRUE}
selected_repcement_THI <- replacement_THI %>% select(Bin, Bin_type, Bout_interval, THI_mean, THI_max, THI_min, index)
selected_repcement_THI$index <-seq(1, nrow(selected_repcement_THI))
cowrep <- selected_repcement_THI %>%
          inner_join(logtable3, by = c("index"))
head(cowrep)
```
## 2. EDA


```{r EDA-1, message=TRUE}
cowrep_THI_high <- cowrep %>% filter(THI_mean >= 75)
cowrep_THI_low <- cowrep %>% filter(THI_mean < 75)
nrow(cowrep_THI_high)
nrow(cowrep_THI_low)

```
